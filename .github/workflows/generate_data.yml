name: Continuous Data Generation
on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}

    - name: Download NNUE Networks
      run: |
        cd src
        wget https://tests.stockfishchess.org/api/nn/nn-c288c895ea92.nnue
        wget https://tests.stockfishchess.org/api/nn/nn-37f18f62d772.nnue

    - name: Build Engine (Linux)
      run: |
        cd src
        g++ -O3 -std=c++17 -Wall -fno-exceptions -DNDEBUG -DIS_64BIT -DUSE_PTHREADS -march=native \
        -Wno-unused-variable -Wno-unused-but-set-variable \
        benchmark.cpp bitboard.cpp evaluate.cpp main.cpp misc.cpp movegen.cpp movepick.cpp \
        position.cpp search.cpp thread.cpp timeman.cpp tt.cpp uci.cpp ucioption.cpp \
        tune.cpp syzygy/tbprobe.cpp nnue/nnue_accumulator.cpp nnue/nnue_misc.cpp \
        nnue/network.cpp nnue/features/half_ka_v2_hm.cpp nnue/features/full_threats.cpp \
        engine.cpp score.cpp memory.cpp nextfish_strategy.cpp nextfish_timeman.cpp \
        datagen.cpp -o ../nextfish -lpthread -latomic

    - name: Run Datagen (Batch of 500 games)
      run: |
        chmod +x nextfish
        ./nextfish datagen nodes 3000 games 500

    - name: Commit & Push Data
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        git config --global user.name 'Nextfish Data Bot'
        git config --global user.email 'bot@nextfish.ai'
        
        # Kiểm tra dung lượng file (90MB = 94371840 bytes)
        FILE="nextfish_data.binpack"
        if [ -f "$FILE" ]; then
          SIZE=$(stat -c%s "$FILE")
          if [ "$SIZE" -gt 94371840 ]; then
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            mv "$FILE" "data_${TIMESTAMP}.binpack"
            echo "File exceeded 90MB, rotated to data_${TIMESTAMP}.binpack"
          fi
        fi

        # Thêm tất cả các file binpack vào git
        git add *.binpack
        
        if git diff --staged --quiet; then
          echo "No new data to commit"
        else
          git commit -m "Add new training data [gen]"
          git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref_name }}
        fi

    - name: Trigger Next Cycle
      if: success()
      env:
        GH_TOKEN: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
      run: |
        echo "Waiting before triggering next run..."
        sleep 10
        gh workflow run generate_data.yml --ref ${{ github.ref_name }} || echo "Manual trigger failed, but push may still work."
